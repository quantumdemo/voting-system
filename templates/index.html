<!-- Digital Voting Landing Page -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nigeria Digital Voting Demo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    .hero {
      background: linear-gradient(to right, #002f6c, #007bff);
      height: 100vh;
      color: white;
      position: relative;
    }
    .hero::after {
      content: "";
      background: url('nigerian-flag.svg') no-repeat center center/cover;
      opacity: 0.08;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      position: absolute;
      z-index: 0;
    }
    .hero .container {
      position: relative;
      z-index: 1;
    }
    .step-icon { font-size: 2rem; color: #007bff; }
  </style>
</head>
<body>
  <!-- Hero Section -->
  <section class="hero d-flex align-items-center justify-content-center text-center">
    <div class="container">
      <h1 class="display-4 fw-bold">Revolutionizing Nigeria‚Äôs Elections with Secure Digital Voting</h1>
      <p class="lead">Transparent, Tamper-Proof, and Accessible Voting for All Nigerians</p>
      <div class="mt-4">
        <a href="#about" class="btn btn-primary btn-lg me-2">Learn More</a>
        <a href="#voteDemo" class="btn btn-outline-light btn-lg">Simulate a Demo Vote</a>
      </div>
    </div>
  </section>

  <!-- About Section -->
  <section id="about" class="py-5">
    <div class="container">
      <h2 class="text-center mb-4">About Digital Voting in Nigeria</h2>
      <div class="row">
        <div class="col-md-6">
          <h5>The Problem</h5>
          <p>Traditional voting methods in Nigeria face serious challenges such as electoral fraud, accessibility issues, delays in result collation, and lack of transparency.</p>
        </div>
        <div class="col-md-6">
          <h5>Our Solution</h5>
          <p>Digital voting offers encrypted, real-time, and tamper-proof elections that ensure inclusivity and speed. Every vote counts and is recorded transparently.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- How It Works -->
  <section id="how-it-works" class="py-5 bg-light">
    <div class="container">
      <h2 class="text-center mb-4">How It Works</h2>
      <div class="row text-center">
        <div class="col-md-4 mb-4">
          <div class="card p-4">
            <div class="step-icon mb-3">üîç</div>
            <h5>Voter Authentication</h5>
            <p>Users authenticate using biometric data or one-time passwords (OTP) sent to registered devices.</p>
          </div>
        </div>
        <div class="col-md-4 mb-4">
          <div class="card p-4">
            <div class="step-icon mb-3">üó≥Ô∏è</div>
            <h5>Secure Ballot Casting</h5>
            <p>Votes are cast via encrypted forms ensuring that no data tampering is possible during transmission.</p>
          </div>
        </div>
        <div class="col-md-4 mb-4">
          <div class="card p-4">
            <div class="step-icon mb-3">üìä</div>
            <h5>Real-Time Results</h5>
            <p>Votes are instantly reflected on a live dashboard with a blockchain-style audit trail for public view.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Demo Voting Simulation -->
  <section id="voteDemo" class="py-5">
    <div class="container">
      <h2 class="text-center mb-4">Simulate a Demo Vote</h2>

      <!-- Stage 1: VIN and Phone Input -->
      <div id="stage1VinPhoneInput">
        <div class="mb-3">
          <input type="text" id="vin" class="form-control" placeholder="Enter Mock Voter ID (VIN)" autocomplete="off">
        </div>
        <div class="mb-3">
          <input type="text" id="phone" class="form-control" placeholder="Enter Registered Phone (Optional, for verification)" autocomplete="off">
        </div>
        <button onclick="requestOtp()" class="btn btn-primary">Request OTP</button>
      </div>

      <!-- Stage 2: OTP Input and Voting -->
      <div id="stage2OtpVote" class="d-none">
        <p id="otpSentMessage" class="text-info"></p>
        <div class="mb-3">
          <input type="text" id="otp" class="form-control" placeholder="Enter OTP Received" autocomplete="off">
        </div>
        <div class="mb-3">
          <select id="candidate" class="form-select">
            <option selected disabled>Select a candidate</option>
            <option value="Candidate A">Candidate A</option>
            <option value="Candidate B">Candidate B</option>
            <option value="Candidate C">Candidate C</option>
          </select>
        </div>
        <button onclick="simulateVote()" class="btn btn-success">Cast Vote</button>
      </div>

      <div id="vote-spinner" class="spinner-border text-primary d-none mt-3" role="status"></div>
      <div id="vote-status" class="mt-3"></div>
    </div>
  </section>

  <!-- Live Results Dashboard -->
  <section class="py-5 bg-light">
    <div class="container">
      <h2 class="text-center mb-4">Live Results</h2>
      <canvas id="resultsChart" width="400" height="200"></canvas>
    </div>
  </section>

  <!-- Security Features -->
  <section class="py-5">
    <div class="container">
      <h2 class="text-center mb-4">Security Features</h2>
      <div class="row text-center">
        <div class="col-md-4">
          <div class="mb-3">üîê</div>
          <h5>End-to-End Encryption</h5>
          <p>Votes are encrypted from the voter's device to the database using strong algorithms.</p>
        </div>
        <div class="col-md-4">
          <div class="mb-3">üßæ</div>
          <h5>Audit Trail</h5>
          <p>All votes are logged with irreversible hashes and timestamp verification.</p>
        </div>
        <div class="col-md-4">
          <div class="mb-3">üõ°Ô∏è</div>
          <h5>Anonymity</h5>
          <p>Voter identity is decoupled from ballot data to ensure privacy and prevent coercion.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- FAQ and Contact Form -->
  <section class="py-5 bg-light">
    <div class="container">
      <h2 class="text-center mb-4">FAQs & Contact</h2>
      <div class="accordion mb-4" id="faqAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header" id="faqOne">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
              Is digital voting safe?
            </button>
          </h2>
          <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
            <div class="accordion-body">Yes, our platform uses end-to-end encryption, audit trails, and decentralized validation.</div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header" id="faqTwo">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
              Can results be tampered with?
            </button>
          </h2>
          <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
            <div class="accordion-body">No. Votes are hashed and verified across multiple ledgers ensuring integrity.</div>
          </div>
        </div>
      </div>

      <form id="contactForm">
        <div class="mb-3">
          <input type="text" class="form-control" placeholder="Your Name" name="name" required>
        </div>
        <div class="mb-3">
          <input type="email" class="form-control" placeholder="Your Email" name="email" required>
        </div>
        <div class="mb-3">
          <textarea class="form-control" placeholder="Your Message" name="message" rows="4" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Send</button>
        <div id="contactResponse" class="mt-3"></div>
      </form>
    </div>
  </section>

  <!-- Footer -->
  <footer class="text-center py-3 bg-dark text-light">
    <div class="container">
      <p>&copy; 2025 Nigeria Digital Voting Demo. All rights reserved.</p>
      <p><small>Demo project for educational purposes only.</small></p>
    </div>
  </footer>

  <!-- Scripts -->
  <script>
    async function simulateVote() {
      const vin = document.getElementById('vin').value;
      const otp = document.getElementById('otp').value;
      const candidate = document.getElementById('candidate').value;
      const spinner = document.getElementById("vote-spinner");
      const statusDiv = document.getElementById("vote-status");

      if (!vin || !otp || candidate === "Select a candidate") {
        statusDiv.innerHTML = '<span class="text-danger">Please fill in all fields and select a candidate.</span>';
        return;
      }

      spinner.classList.remove("d-none");
      statusDiv.innerHTML = "Submitting your vote...";

      try {
        const response = await fetch('/submit_vote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ vin, otp, candidate })
        });
        const result = await response.json();

        if (response.ok && result.status === "success") {
          statusDiv.innerHTML = `<span class="text-success">${result.message}</span>`;
          // We will call fetchResults and updateChart in the next step
        } else {
          statusDiv.innerHTML = `<span class="text-danger">${result.message || 'Error submitting vote.'}</span>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<span class="text-danger">Network error or server unavailable.</span>`;
        console.error("Error submitting vote:", error);
      } finally {
        spinner.classList.add("d-none");
      }
    }

    let resultsChart; // Declare chart variable in a broader scope
    let currentVinForVoting = ""; // Store VIN after OTP request

    async function fetchResults() {
      try {
        const response = await fetch('/get_results');
        if (!response.ok) {
          console.error("Failed to fetch results:", response.status);
          return null;
        }
        const results = await response.json();
        return results;
      } catch (error) {
        console.error("Error fetching results:", error);
        return null;
      }
    }

    function updateChart(newResults) {
      if (!resultsChart || !newResults) return;
      const allCandidates = ['Candidate A', 'Candidate B', 'Candidate C'];
      let labelsToUse = [...new Set([...allCandidates, ...Object.keys(newResults)])]; // Merge and unique

      resultsChart.data.labels = labelsToUse;
      resultsChart.data.datasets[0].data = labelsToUse.map(label => newResults[label] || 0);
      resultsChart.update();
    }

    async function initializeChart() {
      const initialResults = await fetchResults() || { 'Candidate A': 0, 'Candidate B': 0, 'Candidate C': 0 };
      const candidateLabels = ['Candidate A', 'Candidate B', 'Candidate C'];
      const initialData = candidateLabels.map(label => initialResults[label] || 0);

      resultsChart = new Chart(document.getElementById('resultsChart'), {
        type: 'pie',
        data: {
          labels: candidateLabels,
          datasets: [{
            label: 'Votes',
            data: initialData,
            backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6c757d']
          }]
        },
        options: { responsive: true }
      });
      updateChart(initialResults);
    }

    async function requestOtp() {
      const vin = document.getElementById('vin').value;
      const phone = document.getElementById('phone').value; // Optional
      const spinner = document.getElementById("vote-spinner");
      const statusDiv = document.getElementById("vote-status");
      const otpSentMessageDiv = document.getElementById("otpSentMessage");

      if (!vin) {
        statusDiv.innerHTML = '<span class="text-danger">Please enter your Voter ID (VIN).</span>';
        return;
      }

      spinner.classList.remove("d-none");
      statusDiv.innerHTML = "Requesting OTP...";
      otpSentMessageDiv.innerHTML = "";


      try {
        const payload = { vin };
        if (phone) { // Add phone to payload only if it's provided
            payload.phone = phone;
        }
        const response = await fetch('/request_otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await response.json();

        if (response.ok && result.status === "success") {
          currentVinForVoting = vin; // Store VIN for the actual vote submission
          document.getElementById('stage1VinPhoneInput').classList.add('d-none');
          document.getElementById('stage2OtpVote').classList.remove('d-none');
          otpSentMessageDiv.innerHTML = `OTP sent to registered phone ending in ...${result.phone_last4}. Please enter it below. (Test OTP: ${result.otp_for_testing})`; // Display for testing
          statusDiv.innerHTML = ""; // Clear previous status
          // Optionally disable VIN input here or clear it if needed
          document.getElementById('vin').readOnly = true;
          document.getElementById('phone').readOnly = true;
        } else {
          statusDiv.innerHTML = `<span class="text-danger">${result.message || 'Error requesting OTP.'}</span>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<span class="text-danger">Network error or server unavailable while requesting OTP.</span>`;
        console.error("Error requesting OTP:", error);
      } finally {
        spinner.classList.add("d-none");
      }
    }

    async function simulateVote() {
      const otp = document.getElementById('otp').value;
      const candidate = document.getElementById('candidate').value;
      const spinner = document.getElementById("vote-spinner");
      const statusDiv = document.getElementById("vote-status");

      if (!currentVinForVoting) { // Should not happen if UI flow is correct
          statusDiv.innerHTML = '<span class="text-danger">Error: VIN not set. Please request OTP first.</span>';
          return;
      }
      if (!otp || candidate === "Select a candidate") {
        statusDiv.innerHTML = '<span class="text-danger">Please enter OTP and select a candidate.</span>';
        return;
      }

      spinner.classList.remove("d-none");
      statusDiv.innerHTML = "Submitting your vote...";

      try {
        const response = await fetch('/submit_vote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ vin: currentVinForVoting, otp, candidate })
        });
        const result = await response.json();

        if (response.ok && result.status === "success") {
          statusDiv.innerHTML = `<span class="text-success">${result.message}</span>`;
          const latestResults = await fetchResults();
          if (latestResults) updateChart(latestResults);
          // Reset form for next vote simulation after a delay or on a button click
          setTimeout(() => {
            document.getElementById('stage2OtpVote').classList.add('d-none');
            document.getElementById('stage1VinPhoneInput').classList.remove('d-none');
            document.getElementById('otp').value = '';
            document.getElementById('candidate').selectedIndex = 0;
            document.getElementById('vin').readOnly = false;
            document.getElementById('vin').value = '';
            document.getElementById('phone').readOnly = false;
            document.getElementById('phone').value = '';
            statusDiv.innerHTML = "";
            currentVinForVoting = "";
          }, 3000); // Reset after 3 seconds
        } else {
          statusDiv.innerHTML = `<span class="text-danger">${result.message || 'Error submitting vote.'}</span>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<span class="text-danger">Network error or server unavailable.</span>`;
        console.error("Error submitting vote:", error);
      } finally {
        spinner.classList.add("d-none");
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeChart();
      // Ensure correct initial state
      document.getElementById('stage1VinPhoneInput').classList.remove('d-none');
      document.getElementById('stage2OtpVote').classList.add('d-none');
    });

    document.getElementById('contactForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());

      const response = await fetch('/submit_contact', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      document.getElementById('contactResponse').innerText = result.message;
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
